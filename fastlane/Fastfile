default_platform(:ios)

platform :ios do
  desc "Build and sign the app"
  lane :build do
    match(
      type: "appstore",
      readonly: false, # Ensure this is false so it can create a new certificate if needed
      generate_apple_certs: false, # Do not generate new Apple certificates to avoid hitting the limit
      force_for_new_certificates: false, # Do not force create new certificates if limit is reached
      skip_provisioning_profiles: false
    )
    gym(
      scheme: "App",
      export_method: "app-store",
      export_options: {
        compileBitcode: false,
        method: "app-store"
      }
    )
  end

  desc "Deploy the app"
  lane :deploy do
    build_app(
      workspace: "App.xcworkspace",
      scheme: "App",
      export_method: "app-store",
      output_directory: "./build"
    )
    upload_to_app_store
  end
end
